name: Deploy Camunda Files

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: arc-runner-set

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Deploy Camunda Files
      run: |
            #!/bin/bash

            # Server URL
            SERVER_URL="http://10.0.24.77:30000/engine-rest/deployment/create"

            # Tempor채rer Ordner zum Speichern der heruntergeladenen Dateien
            TEMP_DIR="c:/temp/camunda"

            # Erstelle den tempor채ren Ordner, falls er nicht existiert
            mkdir -p "$TEMP_DIR"

            # Dateien zum Herunterladen
            FILES=(
                "https://raw.githubusercontent.com/Bazzako/SemArb4-CD-und-Camunda-BPM/main/processesGrundgeruest.bpmn"
                "https://raw.githubusercontent.com/Bazzako/SemArb4-CD-und-Camunda-BPM/main/processesAnmeldeformular.form"
                "https://raw.githubusercontent.com/Bazzako/SemArb4-CD-und-Camunda-BPM/main/processesDatenerfassung.form"
                "https://raw.githubusercontent.com/Bazzako/SemArb4-CD-und-Camunda-BPM/main/processesDatensicherung.form"
                "https://raw.githubusercontent.com/Bazzako/SemArb4-CD-und-Camunda-BPM/main/processesDefektanalyse.form"
                "https://raw.githubusercontent.com/Bazzako/SemArb4-CD-und-Camunda-BPM/main/processesAbholung.form"
            )

            # Herunterladen der Dateien in den tempor채ren Ordner
            for FILE in "${FILES[@]}"
            do
                BASENAME=$(basename "$FILE")
                TEMP_FILE="$TEMP_DIR/$BASENAME"
                
                echo "Downloading file: $FILE"
                curl -s -o "$TEMP_FILE" "$FILE"
                
                if [ ! -f "$TEMP_FILE" ]; then
                    echo "Error: Failed to download $FILE"
                    exit 1
                fi
            done

            # Hochladen der heruntergeladenen Dateien
            for FILE in "${FILES[@]}"
            do
                BASENAME=$(basename "$FILE")
                TEMP_FILE="$TEMP_DIR/$BASENAME"
                
                echo "Uploading file: $TEMP_FILE"
                curl --location "$SERVER_URL" \
                    --header 'Content-Type: multipart/form-data' \
                    --form "upload=@$TEMP_FILE"
                
                if [ $? -ne 0 ]; then
                    echo "Error: Failed to upload $TEMP_FILE"
                    exit 1
                fi
                
                sleep 1
            done

            # Bereinigen des tempor채ren Ordners
            rm -r "$TEMP_DIR"

            echo "All files have been successfully uploaded."
